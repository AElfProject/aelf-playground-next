import { processTestOutput } from './process-test-output';
import { describe, it, expect } from 'vitest';

const testString = `Process exited with code 1. Details:   Determining projects to restore...\n  Restored /tmp/playground/08993f10-e0ef-4bbf-b6e0-5a5ce4fa71e3/src/MyWayDAO.csproj (in 1.57 sec).\n  Restored /tmp/playground/08993f10-e0ef-4bbf-b6e0-5a5ce4fa71e3/test/MyWayDAO.Tests.csproj (in 3.28 sec).\nProtobuf/reference/acs12.proto(13,1): warning : warning: Import aelf/core.proto is unused. [/tmp/playground/08993f10-e0ef-4bbf-b6e0-5a5ce4fa71e3/src/MyWayDAO.csproj]\n  MyWayDAO -> /tmp/playground/08993f10-e0ef-4bbf-b6e0-5a5ce4fa71e3/src/bin/Debug/net6.0/MyWayDAO.dll\n  [CONTRACT-PATCHER] Saving as /tmp/playground/08993f10-e0ef-4bbf-b6e0-5a5ce4fa71e3/src/bin/Debug/net6.0/MyWayDAO.dll.patched\nProtobuf/reference/acs12.proto(13,1): warning : warning: Import aelf/core.proto is unused. [/tmp/playground/08993f10-e0ef-4bbf-b6e0-5a5ce4fa71e3/test/MyWayDAO.Tests.csproj]\n  MyWayDAO.Tests -> /tmp/playground/08993f10-e0ef-4bbf-b6e0-5a5ce4fa71e3/test/bin/Debug/net6.0/MyWayDAO.Tests.dll\nTest run for /tmp/playground/08993f10-e0ef-4bbf-b6e0-5a5ce4fa71e3/test/bin/Debug/net6.0/MyWayDAO.Tests.dll (.NETCoreApp,Version=v6.0)\nMicrosoft (R) Test Execution Command Line Tool Version 17.3.3 (x64)\nCopyright (c) Microsoft Corporation.  All rights reserved.\n\nStarting test execution, please wait...\nA total of 1 test files matched the specified pattern.\n/tmp/playground/08993f10-e0ef-4bbf-b6e0-5a5ce4fa71e3/test/bin/Debug/net6.0/MyWayDAO.Tests.dll\n[xUnit.net 00:00:00.00] xUnit.net VSTest Adapter v2.4.1 (64-bit .NET 6.0.18)\n[xUnit.net 00:00:03.21]   Discovering: MyWayDAO.Tests\n[xUnit.net 00:00:03.27]   Discovered:  MyWayDAO.Tests\n[xUnit.net 00:00:03.28]   Starting:    MyWayDAO.Tests\n  Passed AElf.Contracts.MyWayDAO.MyWayDAOTests.GetAllProposals_Empty [5 s]\n  Passed AElf.Contracts.MyWayDAO.MyWayDAOTests.HasVoted_ProposalNotFound_ShouldThrow [2 s]\n  Passed AElf.Contracts.MyWayDAO.MyWayDAOTests.Vote_MultipleUsers_ShouldSucceed [2 s]\n  Passed AElf.Contracts.MyWayDAO.MyWayDAOTests.Vote_ProposalNotFound_ShouldThrow [1 s]\n  Passed AElf.Contracts.MyWayDAO.MyWayDAOTests.Vote_Success_Reject [838 ms]\n  Passed AElf.Contracts.MyWayDAO.MyWayDAOTests.CreateProposal_InvalidStartTime_ShouldThrow [835 ms]\n  Passed AElf.Contracts.MyWayDAO.MyWayDAOTests.Vote_Success_Approve [1 s]\n  Passed AElf.Contracts.MyWayDAO.MyWayDAOTests.GetAllProposals_ProposalsWithDifferentStates [715 ms]\n  Passed AElf.Contracts.MyWayDAO.MyWayDAOTests.Withdraw_ProposalNotFound_ShouldThrow [1 s]\n  Passed AElf.Contracts.MyWayDAO.MyWayDAOTests.GetProposal_Success [867 ms]\n  Passed AElf.Contracts.MyWayDAO.MyWayDAOTests.GetAllProposals_MultipleProposals [606 ms]\n  Passed AElf.Contracts.MyWayDAO.MyWayDAOTests.InitializeContract_Fail_AlreadyInitialized [848 ms]\n\nTotal tests: Unknown\n     Passed: 12\n Total time: 28.0595 Seconds\n\nThe active test run was aborted. Reason: Test host process crashed\nTest Run Aborted with error System.Exception: One or more errors occurred.\n ---> System.Exception: Unable to read beyond the end of the stream.\n   at System.IO.BinaryReader.Read7BitEncodedInt()\n   at System.IO.BinaryReader.ReadString()\n   at Microsoft.VisualStudio.TestPlatform.CommunicationUtilities.LengthPrefixCommunicationChannel.NotifyDataAvailable()\n   at Microsoft.VisualStudio.TestPlatform.CommunicationUtilities.TcpClientExtensions.MessageLoopAsync(TcpClient client, ICommunicationChannel channel, Action\`1 errorHandler, CancellationToken cancellationToken)\n   --- End of inner exception stack trace ---.\n\n`;

describe('processTestOutput', () => {
  it('should return an empty array for an empty string', () => {
    const result = processTestOutput('');
    expect(result).toEqual([]);
  });

  it('should return an array of test results for a valid test output string', () => {
    const result = processTestOutput(testString);
    expect(result).toEqual([
      { status: 'passed', name: 'AElf.Contracts.MyWayDAO.MyWayDAOTests.GetAllProposals_Empty', duration: 5000, message: undefined },
      { status: 'passed', name: 'AElf.Contracts.MyWayDAO.MyWayDAOTests.HasVoted_ProposalNotFound_ShouldThrow', duration: 2000, message: undefined },
      { status: 'passed', name: 'AElf.Contracts.MyWayDAO.MyWayDAOTests.Vote_MultipleUsers_ShouldSucceed', duration: 2000, message: undefined },
      { status: 'passed', name: 'AElf.Contracts.MyWayDAO.MyWayDAOTests.Vote_ProposalNotFound_ShouldThrow', duration: 1000, message: undefined },
      { status: 'passed', name: 'AElf.Contracts.MyWayDAO.MyWayDAOTests.Vote_Success_Reject', duration: 838, message: undefined },
      { status: 'passed', name: 'AElf.Contracts.MyWayDAO.MyWayDAOTests.CreateProposal_InvalidStartTime_ShouldThrow', duration: 835, message: undefined },
      { status: 'passed', name: 'AElf.Contracts.MyWayDAO.MyWayDAOTests.Vote_Success_Approve', duration: 1000, message: undefined },
      { status: 'passed', name: 'AElf.Contracts.MyWayDAO.MyWayDAOTests.GetAllProposals_ProposalsWithDifferentStates', duration: 715, message: undefined },
      { status: 'passed', name: 'AElf.Contracts.MyWayDAO.MyWayDAOTests.Withdraw_ProposalNotFound_ShouldThrow', duration: 1000, message: undefined },
      { status: 'passed', name: 'AElf.Contracts.MyWayDAO.MyWayDAOTests.GetProposal_Success', duration: 867, message: undefined },
      { status: 'passed', name: 'AElf.Contracts.MyWayDAO.MyWayDAOTests.GetAllProposals_MultipleProposals', duration: 606, message: undefined },
      { status: 'passed', name: 'AElf.Contracts.MyWayDAO.MyWayDAOTests.InitializeContract_Fail_AlreadyInitialized', duration: 848, message: undefined }
    ]);
  });

  it('should handle test output with no passed tests', () => {
    const noPassedTestsString = `Test run for /tmp/playground/08993f10-e0ef-4bbf-b6e0-5a5ce4fa71e3/test/bin/Debug/net6.0/MyWayDAO.Tests.dll (.NETCoreApp,Version=v6.0)\nMicrosoft (R) Test Execution Command Line Tool Version 17.3.3 (x64)\nCopyright (c) Microsoft Corporation.  All rights reserved.\n\nStarting test execution, please wait...\nA total of 1 test files matched the specified pattern.\n/tmp/playground/08993f10-e0ef-4bbf-b6e0-5a5ce4fa71e3/test/bin/Debug/net6.0/MyWayDAO.Tests.dll\n[xUnit.net 00:00:00.00] xUnit.net VSTest Adapter v2.4.1 (64-bit .NET 6.0.18)\n[xUnit.net 00:00:03.21]   Discovering: MyWayDAO.Tests\n[xUnit.net 00:00:03.27]   Discovered:  MyWayDAO.Tests\n[xUnit.net 00:00:03.28]   Starting:    MyWayDAO.Tests\n\nTotal tests: Unknown\n     Passed: 0\n Total time: 0 Seconds\n\nThe active test run was aborted. Reason: Test host process crashed\nTest Run Aborted with error System.Exception: One or more errors occurred.\n ---> System.Exception: Unable to read beyond the end of the stream.\n   at System.IO.BinaryReader.Read7BitEncodedInt()\n   at System.IO.BinaryReader.ReadString()\n   at Microsoft.VisualStudio.TestPlatform.CommunicationUtilities.LengthPrefixCommunicationChannel.NotifyDataAvailable()\n   at Microsoft.VisualStudio.TestPlatform.CommunicationUtilities.TcpClientExtensions.MessageLoopAsync(TcpClient client, ICommunicationChannel channel, Action\`1 errorHandler, CancellationToken cancellationToken)\n   --- End of inner exception stack trace ---.\n\n`;
    const result = processTestOutput(noPassedTestsString);
    expect(result).toEqual([]);
  });

  it('should handle test output with mixed results', () => {
    const mixedResultsString = `Test run for /tmp/playground/08993f10-e0ef-4bbf-b6e0-5a5ce4fa71e3/test/bin/Debug/net6.0/MyWayDAO.Tests.dll (.NETCoreApp,Version=v6.0)\nMicrosoft (R) Test Execution Command Line Tool Version 17.3.3 (x64)\nCopyright (c) Microsoft Corporation.  All rights reserved.\n\nStarting test execution, please wait...\nA total of 1 test files matched the specified pattern.\n/tmp/playground/08993f10-e0ef-4bbf-b6e0-5a5ce4fa71e3/test/bin/Debug/net6.0/MyWayDAO.Tests.dll\n[xUnit.net 00:00:00.00] xUnit.net VSTest Adapter v2.4.1 (64-bit .NET 6.0.18)\n[xUnit.net 00:00:03.21]   Discovering: MyWayDAO.Tests\n[xUnit.net 00:00:03.27]   Discovered:  MyWayDAO.Tests\n[xUnit.net 00:00:03.28]   Starting:    MyWayDAO.Tests\n  Passed AElf.Contracts.MyWayDAO.MyWayDAOTests.GetAllProposals_Empty [5 s]\n  Failed AElf.Contracts.MyWayDAO.MyWayDAOTests.HasVoted_ProposalNotFound_ShouldThrow [2 s]\n\nTotal tests: Unknown\n     Passed: 1\n     Failed: 1\n Total time: 7 Seconds\n\nThe active test run was aborted. Reason: Test host process crashed\nTest Run Aborted with error System.Exception: One or more errors occurred.\n ---> System.Exception: Unable to read beyond the end of the stream.\n   at System.IO.BinaryReader.Read7BitEncodedInt()\n   at System.IO.BinaryReader.ReadString()\n   at Microsoft.VisualStudio.TestPlatform.CommunicationUtilities.LengthPrefixCommunicationChannel.NotifyDataAvailable()\n   at Microsoft.VisualStudio.TestPlatform.CommunicationUtilities.TcpClientExtensions.MessageLoopAsync(TcpClient client, ICommunicationChannel channel, Action\`1 errorHandler, CancellationToken cancellationToken)\n   --- End of inner exception stack trace ---.\n\n`;
    const result = processTestOutput(mixedResultsString);
    expect(result).toEqual([
      { status: 'passed', name: 'AElf.Contracts.MyWayDAO.MyWayDAOTests.GetAllProposals_Empty', duration: 5000, message: undefined },
      { status: 'failed', name: 'AElf.Contracts.MyWayDAO.MyWayDAOTests.HasVoted_ProposalNotFound_ShouldThrow', duration: 2000, message: "" }
    ]);
  });

  it('should show the details of the failed test', () => {
    const testWithFailure = "Process exited with code 1. Details:   Determining projects to restore...\n  Restored /tmp/playground/362fc693-ea25-4197-bc72-6e7b41255edb/src/dao.csproj (in 1.28 sec).\n  Restored /tmp/playground/362fc693-ea25-4197-bc72-6e7b41255edb/test/dao.Tests.csproj (in 2.66 sec).\nProtobuf/reference/acs12.proto(13,1): warning : warning: Import aelf/core.proto is unused. [/tmp/playground/362fc693-ea25-4197-bc72-6e7b41255edb/src/dao.csproj]\n  dao -> /tmp/playground/362fc693-ea25-4197-bc72-6e7b41255edb/src/bin/Debug/net6.0/dao.dll\n  [CONTRACT-PATCHER] Saving as /tmp/playground/362fc693-ea25-4197-bc72-6e7b41255edb/src/bin/Debug/net6.0/dao.dll.patched\nProtobuf/reference/acs12.proto(13,1): warning : warning: Import aelf/core.proto is unused. [/tmp/playground/362fc693-ea25-4197-bc72-6e7b41255edb/test/dao.Tests.csproj]\n  dao.Tests -> /tmp/playground/362fc693-ea25-4197-bc72-6e7b41255edb/test/bin/Debug/net6.0/dao.Tests.dll\nTest run for /tmp/playground/362fc693-ea25-4197-bc72-6e7b41255edb/test/bin/Debug/net6.0/dao.Tests.dll (.NETCoreApp,Version=v6.0)\nMicrosoft (R) Test Execution Command Line Tool Version 17.3.3 (x64)\nCopyright (c) Microsoft Corporation.  All rights reserved.\n\nStarting test execution, please wait...\nA total of 1 test files matched the specified pattern.\n/tmp/playground/362fc693-ea25-4197-bc72-6e7b41255edb/test/bin/Debug/net6.0/dao.Tests.dll\n[xUnit.net 00:00:00.00] xUnit.net VSTest Adapter v2.4.1 (64-bit .NET 6.0.18)\n[xUnit.net 00:00:02.35]   Discovering: dao.Tests\n[xUnit.net 00:00:02.40]   Discovered:  dao.Tests\n[xUnit.net 00:00:02.40]   Starting:    dao.Tests\n  Passed AElf.Contracts.dao.daoTests.GetAllProposals_ProposalsWithDifferentStates [4 s]\n  Passed AElf.Contracts.dao.daoTests.GetAllProposals_MultipleProposals [1 s]\n  Passed AElf.Contracts.dao.daoTests.GetProposal_Success [1 s]\n[xUnit.net 00:00:11.85]       Shouldly.ShouldAssertException : exception.Message\n[xUnit.net 00:00:11.85]           should contain (case insensitive comparison)\n[xUnit.net 00:00:11.85]       \"Start time should be greater or equal to current block tie.\"\n[xUnit.net 00:00:11.85]           but was actually\n[xUnit.net 00:00:11.85]       \"Failed to execute CreateProposal. AElf.Sdk.CSharp.AssertionException: Start time should be greater o...\"\n[xUnit.net 00:00:11.85]       Stack Trace:\n[xUnit.net 00:00:11.85]         /tmp/playground/362fc693-ea25-4197-bc72-6e7b41255edb/test/daoTests.cs(135,0): at AElf.Contracts.dao.daoTests.CreateProposal_InvalidStartTime_ShouldThrow()\n[xUnit.net 00:00:11.85]            at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\n[xUnit.net 00:00:11.85]            at System.Runtime.CompilerServices.TaskAwaiter.ThrowForNonSuccess(Task task)\n[xUnit.net 00:00:11.85]            at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\n[xUnit.net 00:00:11.85]         --- End of stack trace from previous location ---\n[xUnit.net 00:00:11.85]            at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\n[xUnit.net 00:00:11.85]            at System.Runtime.CompilerServices.TaskAwaiter.ThrowForNonSuccess(Task task)\n[xUnit.net 00:00:11.85]            at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\n[xUnit.net 00:00:11.85]            at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\n[xUnit.net 00:00:11.85]            at System.Runtime.CompilerServices.TaskAwaiter.ThrowForNonSuccess(Task task)\n[xUnit.net 00:00:11.85]            at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\n  Passed AElf.Contracts.dao.daoTests.InitializeContract_Fail_AlreadyInitialized [1 s]\n  Failed AElf.Contracts.dao.daoTests.CreateProposal_InvalidStartTime_ShouldThrow [988 ms]\n  Error Message:\n   Shouldly.ShouldAssertException : exception.Message\n    should contain (case insensitive comparison)\n\"Start time should be greater or equal to current block tie.\"\n    but was actually\n\"Failed to execute CreateProposal. AElf.Sdk.CSharp.AssertionException: Start time should be greater o...\"\n  Stack Trace:\n     at AElf.Contracts.dao.daoTests.CreateProposal_InvalidStartTime_ShouldThrow() in /tmp/playground/362fc693-ea25-4197-bc72-6e7b41255edb/test/daoTests.cs:line 135\n   at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\n   at System.Runtime.CompilerServices.TaskAwaiter.ThrowForNonSuccess(Task task)\n   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\n--- End of stack trace from previous location ---\n   at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\n   at System.Runtime.CompilerServices.TaskAwaiter.ThrowForNonSuccess(Task task)\n   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\n   at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\n   at System.Runtime.CompilerServices.TaskAwaiter.ThrowForNonSuccess(Task task)\n   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\n  Passed AElf.Contracts.dao.daoTests.CreateProposal_EmptyDescription_ShouldThrow [1 s]\n  Passed AElf.Contracts.dao.daoTests.Withdraw_ProposalNotFound_ShouldThrow [939 ms]\n  Passed AElf.Contracts.dao.daoTests.Withdraw_MultipleUsersAttempting_Success [977 ms]\n  Passed AElf.Contracts.dao.daoTests.GetProposal_ProposalWithVotes_ShouldSucceed [1 s]\n\nTotal tests: Unknown\n     Passed: 8\n     Failed: 1\n Total time: 21.6233 Seconds\n\n[xUnit.net 00:00:11.85]     AElf.Contracts.dao.daoTests.CreateProposal_InvalidStartTime_ShouldThrow [FAIL]\nThe active test run was aborted. Reason: Test host process crashed\nTest Run Aborted with error System.Exception: One or more errors occurred.\n ---> System.Exception: Unable to read beyond the end of the stream.\n   at System.IO.BinaryReader.Read7BitEncodedInt()\n   at System.IO.BinaryReader.ReadString()\n   at Microsoft.VisualStudio.TestPlatform.CommunicationUtilities.LengthPrefixCommunicationChannel.NotifyDataAvailable()\n   at Microsoft.VisualStudio.TestPlatform.CommunicationUtilities.TcpClientExtensions.MessageLoopAsync(TcpClient client, ICommunicationChannel channel, Action`1 errorHandler, CancellationToken cancellationToken)\n   --- End of inner exception stack trace ---.\n\n";
    const result = processTestOutput(testWithFailure);
    expect(result).toEqual([
      { status: 'passed', name: 'AElf.Contracts.dao.daoTests.GetAllProposals_ProposalsWithDifferentStates', duration: 4000, message: undefined },
      { status: 'passed', name: 'AElf.Contracts.dao.daoTests.GetAllProposals_MultipleProposals', duration: 1000, message: undefined },
      { status: 'passed', name: 'AElf.Contracts.dao.daoTests.GetProposal_Success', duration: 1000, message: undefined },
      { status: 'failed', name: 'AElf.Contracts.dao.daoTests.CreateProposal_InvalidStartTime_ShouldThrow', duration: 988, message: "Shouldly.ShouldAssertException : exception.Message should contain (case insensitive comparison) \"Start time should be greater or equal to current block tie.\" but was actually \"Failed to execute CreateProposal. AElf.Sdk.CSharp.AssertionException: Start time should be greater o...\"" },
      { status: 'passed', name: 'AElf.Contracts.dao.daoTests.InitializeContract_Fail_AlreadyInitialized', duration: 1000, message: undefined },
      { status: 'passed', name: 'AElf.Contracts.dao.daoTests.CreateProposal_EmptyDescription_ShouldThrow', duration: 1000, message: undefined },
      { status: 'passed', name: 'AElf.Contracts.dao.daoTests.Withdraw_ProposalNotFound_ShouldThrow', duration: 939, message: undefined },
      { status: 'passed', name: 'AElf.Contracts.dao.daoTests.Withdraw_MultipleUsersAttempting_Success', duration: 977, message: undefined },
      { status: 'passed', name: 'AElf.Contracts.dao.daoTests.GetProposal_ProposalWithVotes_ShouldSucceed', duration: 1000, message: undefined }
    ]);
  });
});

